<!DOCTYPE html>
<html lang="zh-ch">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>示例 - Dataset 自定义弹性扩缩容 | Fluid</title>
    <meta name="generator" content="VuePress 1.8.3">
    <link rel="icon" href="/fluid-stacked-color.svg">
    <meta name="description" content="Fluid, 在云上为大数据以及AI应用的弹性数据提供抽象和加速服务。">
    
    <link rel="preload" href="/assets/css/0.styles.a3f68dae.css" as="style"><link rel="preload" href="/assets/js/app.23af35ae.js" as="script"><link rel="preload" href="/assets/js/2.886cbf07.js" as="script"><link rel="preload" href="/assets/js/3.43a2579f.js" as="script"><link rel="preload" href="/assets/js/43.47cde8a4.js" as="script"><link rel="prefetch" href="/assets/js/10.94391121.js"><link rel="prefetch" href="/assets/js/11.541d21e0.js"><link rel="prefetch" href="/assets/js/12.e279f2da.js"><link rel="prefetch" href="/assets/js/13.3624478c.js"><link rel="prefetch" href="/assets/js/14.44436758.js"><link rel="prefetch" href="/assets/js/15.b0b808a9.js"><link rel="prefetch" href="/assets/js/16.a13987ff.js"><link rel="prefetch" href="/assets/js/17.9aa1d6c2.js"><link rel="prefetch" href="/assets/js/18.ca725e7f.js"><link rel="prefetch" href="/assets/js/19.d61e1b85.js"><link rel="prefetch" href="/assets/js/20.87684a78.js"><link rel="prefetch" href="/assets/js/21.63d567df.js"><link rel="prefetch" href="/assets/js/22.cb36f6e5.js"><link rel="prefetch" href="/assets/js/23.b3d4ae25.js"><link rel="prefetch" href="/assets/js/24.90c5ebb3.js"><link rel="prefetch" href="/assets/js/25.8064cf0e.js"><link rel="prefetch" href="/assets/js/26.f2e8d0f7.js"><link rel="prefetch" href="/assets/js/27.14aa189f.js"><link rel="prefetch" href="/assets/js/28.fcbf49cf.js"><link rel="prefetch" href="/assets/js/29.a9659ee6.js"><link rel="prefetch" href="/assets/js/30.861fad3e.js"><link rel="prefetch" href="/assets/js/31.746f7dcb.js"><link rel="prefetch" href="/assets/js/32.d220ce6c.js"><link rel="prefetch" href="/assets/js/33.191f1649.js"><link rel="prefetch" href="/assets/js/34.82c2f9b9.js"><link rel="prefetch" href="/assets/js/35.79ca754a.js"><link rel="prefetch" href="/assets/js/36.e5ab9813.js"><link rel="prefetch" href="/assets/js/37.172cc3e7.js"><link rel="prefetch" href="/assets/js/38.2eae18fd.js"><link rel="prefetch" href="/assets/js/39.053d5c9a.js"><link rel="prefetch" href="/assets/js/4.ea15b34c.js"><link rel="prefetch" href="/assets/js/40.1505f57b.js"><link rel="prefetch" href="/assets/js/41.73ef4b43.js"><link rel="prefetch" href="/assets/js/42.b2e0c99f.js"><link rel="prefetch" href="/assets/js/44.eb34b846.js"><link rel="prefetch" href="/assets/js/45.488ece96.js"><link rel="prefetch" href="/assets/js/46.381551c7.js"><link rel="prefetch" href="/assets/js/47.c0fbc781.js"><link rel="prefetch" href="/assets/js/5.c0ae63ef.js"><link rel="prefetch" href="/assets/js/6.616cc39d.js"><link rel="prefetch" href="/assets/js/7.bc4a856f.js"><link rel="prefetch" href="/assets/js/8.34aeb8f3.js"><link rel="prefetch" href="/assets/js/9.f5329c38.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a3f68dae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/fluid-horizontal-color.png" alt="Fluid" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title">文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="文档" class="mobile-dropdown-title"><span class="title">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/doc/guide.html" class="nav-link">
  指南
</a></li><li class="dropdown-item"><!----> <a href="/zh/doc/dev.html" class="nav-link">
  开发
</a></li><li class="dropdown-item"><!----> <a href="/zh/doc/samples.html" class="nav-link">
  示例
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="社区" class="dropdown-title"><span class="title">社区</span> <span class="arrow down"></span></button> <button type="button" aria-label="社区" class="mobile-dropdown-title"><span class="title">社区</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/community/community.html" class="nav-link">
  社区
</a></li><li class="dropdown-item"><!----> <a href="/zh/community/ADOPTERS.html" class="nav-link">
  用户
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blog/technology/" class="nav-link">
  技术内幕
</a></li><li class="dropdown-item"><!----> <a href="/zh/blog/releases/" class="nav-link">
  版本发布
</a></li><li class="dropdown-item"><!----> <a href="/zh/blog/casestudy/" class="nav-link">
  案例学习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/operation/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/fluid-cloudnative/fluid" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title">文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="文档" class="mobile-dropdown-title"><span class="title">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/doc/guide.html" class="nav-link">
  指南
</a></li><li class="dropdown-item"><!----> <a href="/zh/doc/dev.html" class="nav-link">
  开发
</a></li><li class="dropdown-item"><!----> <a href="/zh/doc/samples.html" class="nav-link">
  示例
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="社区" class="dropdown-title"><span class="title">社区</span> <span class="arrow down"></span></button> <button type="button" aria-label="社区" class="mobile-dropdown-title"><span class="title">社区</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/community/community.html" class="nav-link">
  社区
</a></li><li class="dropdown-item"><!----> <a href="/zh/community/ADOPTERS.html" class="nav-link">
  用户
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blog/technology/" class="nav-link">
  技术内幕
</a></li><li class="dropdown-item"><!----> <a href="/zh/blog/releases/" class="nav-link">
  版本发布
</a></li><li class="dropdown-item"><!----> <a href="/zh/blog/casestudy/" class="nav-link">
  案例学习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/operation/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/fluid-cloudnative/fluid" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="示例-dataset-自定义弹性扩缩容"><a href="#示例-dataset-自定义弹性扩缩容" class="header-anchor">#</a> 示例 - Dataset 自定义弹性扩缩容</h1> <p>Fluid 可以通过创建 Dataset 对象将数据分散到 Kubernetes 计算节点中，作为数据交换的介质，可以有效避免了数据的远程写入和读取，提升了数据使用的效率。
但是这里的问题是数据缓存的资源预估和预留。由于在数据生产消费之前，精准的数据预估是比较难以满足的，使用按需扩缩容对于使用者更加友好。
按需扩缩容技术类似于 page cache，对于用户而言这一层是透明的但是它带来的加速效果是很明显的。</p> <p>通过自定义 HPA 机制，使得 Fluid 引入了缓存弹性伸缩能力。弹性伸缩的条件就是当已有缓存数据量达到一定比例时就会发生弹性扩容缓存空间。例如
触发条件设置为占比超过 80%，总的缓存空间为 10G,当数据占满到 8G 缓存空间时，就会触发扩缩容。</p> <p>本文将向你展示这一特性。</p> <h2 id="前提条件"><a href="#前提条件" class="header-anchor">#</a> 前提条件</h2> <p>推荐使用 Kubernetes 1.18 以上，因为在 1.18 之前，HPA 是无法自定义扩缩容策略的，都是通过硬编码实现的。而在 1.18 后，用户可以自定义扩缩容策略的，比如可以定义一次扩容后的冷却时间。</p> <h2 id="具体步骤"><a href="#具体步骤" class="header-anchor">#</a> 具体步骤</h2> <ol><li>安装 jq 工具方便解析 json，在本例子中我们使用操作系统是 Centos，可以通过 yum 安装 jq</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ yum <span class="token function">install</span> <span class="token parameter variable">-y</span> jq
</code></pre></div><ol start="2"><li>下载、安装 Fluid 最新版</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">git</span> clone https://github.com/fluid-cloudnative/fluid.git
$ <span class="token builtin class-name">cd</span> fluid/charts
$ kubectl create ns fluid-system
$ helm <span class="token function">install</span> fluid fluid
</code></pre></div><ol start="3"><li>部署或配置 Prometheus</li></ol> <p>这里通过 Prometheus 对于 AlluxioRuntime 的缓存引擎暴露的 Metrics 进行收集，如果集群内无 Prometheus:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">cd</span> fluid
$ kubectl apply <span class="token parameter variable">-f</span> integration/prometheus/prometheus.yaml
</code></pre></div><p>如集群内有 Prometheus,可将以下配置写到 Prometheus 配置文件中:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'alluxio runtime'</span>
    <span class="token key atrule">metrics_path</span><span class="token punctuation">:</span> /metrics/prometheus
    <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> endpoints
    <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_label_monitor<span class="token punctuation">]</span>
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> alluxio_runtime_metrics
      <span class="token key atrule">action</span><span class="token punctuation">:</span> keep
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_endpoint_port_name<span class="token punctuation">]</span>
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> web
      <span class="token key atrule">action</span><span class="token punctuation">:</span> keep
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">]</span>
      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> namespace
      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_label_release<span class="token punctuation">]</span>
      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> fluid_runtime
      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_endpoint_address_target_name<span class="token punctuation">]</span>
      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> pod
      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
</code></pre></div><ol start="4"><li>验证 Prometheus 安装成功</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get ep <span class="token parameter variable">-n</span> kube-system  prometheus-svc
NAME             ENDPOINTS        AGE
prometheus-svc   <span class="token number">10.76</span>.0.2:9090   6m49s
$ kubectl get svc <span class="token parameter variable">-n</span> kube-system prometheus-svc
NAME             TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
prometheus-svc   NodePort   <span class="token number">172.16</span>.135.24   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9090</span>:32114/TCP   2m7s
</code></pre></div><p>如果希望可视化监控指标，您可以安装 Grafana 验证监控数据，具体操作可以参考<a href="/zh/operation/monitoring.html">文档</a></p> <ol start="5"><li>部署 metrics server</li></ol> <p>检查该集群是否包括 metrics-server, 执行 kubectl top node 有正确输出可以显示内存和 CPU，则该集群 metrics server 配置正确</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token function">top</span> <span class="token function">node</span>
NAME                       CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%
<span class="token number">192.168</span>.1.204   93m          <span class="token number">2</span>%     1455Mi          <span class="token number">10</span>%
<span class="token number">192.168</span>.1.205   125m         <span class="token number">3</span>%     1925Mi          <span class="token number">13</span>%
<span class="token number">192.168</span>.1.206   96m          <span class="token number">2</span>%     1689Mi          <span class="token number">11</span>%
</code></pre></div><p>否则手动执行以下命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl create <span class="token parameter variable">-f</span> integration/metrics-server
</code></pre></div><ol start="6"><li>部署 custom-metrics-api 组件</li></ol> <p>为了基于自定义指标进行扩展，你需要拥有两个组件。第一个组件是从应用程序收集指标并将其存储到 Prometheus 时间序列数据库。第二个组件使用收集的度量指标来扩展 Kubernetes 自定义 metrics API，即 k8s-prometheus-adapter。第一个组件在第三步部署完成，下面部署第二个组件：</p> <p>如果已经配置了 custom-metrics-api，在 adapter 的 configmap 配置中增加与 dataset 相关的配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> adapter<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">config.yaml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    rules:
    - seriesQuery: '{__name__=~&quot;Cluster_(CapacityTotal|CapacityUsed)&quot;,fluid_runtime!=&quot;&quot;,instance!=&quot;&quot;,job=&quot;alluxio runtime&quot;,namespace!=&quot;&quot;,pod!=&quot;&quot;}'
      seriesFilters:
      - is: ^Cluster_(CapacityTotal|CapacityUsed)$
      resources:
        overrides:
          namespace:
            resource: namespace
          pod:
            resource: pods
          fluid_runtime:
            resource: datasets
      name:
        matches: &quot;^(.*)&quot;
        as: &quot;capacity_used_rate&quot;
      metricsQuery: ceil(Cluster_CapacityUsed{&lt;&lt;.LabelMatchers&gt;&gt;}*100/(Cluster_CapacityTotal{&lt;&lt;.LabelMatchers&gt;&gt;}))</span>
</code></pre></div><p>否则手动执行以下命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl create <span class="token parameter variable">-f</span> integration/custom-metrics-api/namespace.yaml
$ kubectl create <span class="token parameter variable">-f</span> integration/custom-metrics-api
</code></pre></div><blockquote><p>注意：因为 custom-metrics-api 对接集群中的 Prometheous 的访问地址，请替换 Prometheous url 为你真正使用的 Prometheous 地址。</p></blockquote> <p>检查自定义指标</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get <span class="token parameter variable">--raw</span> <span class="token string">&quot;/apis/custom.metrics.k8s.io/v1beta1&quot;</span> <span class="token operator">|</span> jq
<span class="token punctuation">{</span>
  <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;APIResourceList&quot;</span>,
  <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1&quot;</span>,
  <span class="token string">&quot;groupVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;custom.metrics.k8s.io/v1beta1&quot;</span>,
  <span class="token string">&quot;resources&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pods/capacity_used_rate&quot;</span>,
      <span class="token string">&quot;singularName&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
      <span class="token string">&quot;namespaced&quot;</span><span class="token builtin class-name">:</span> true,
      <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;MetricValueList&quot;</span>,
      <span class="token string">&quot;verbs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;get&quot;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;datasets.data.fluid.io/capacity_used_rate&quot;</span>,
      <span class="token string">&quot;singularName&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
      <span class="token string">&quot;namespaced&quot;</span><span class="token builtin class-name">:</span> true,
      <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;MetricValueList&quot;</span>,
      <span class="token string">&quot;verbs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;get&quot;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;namespaces/capacity_used_rate&quot;</span>,
      <span class="token string">&quot;singularName&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
      <span class="token string">&quot;namespaced&quot;</span><span class="token builtin class-name">:</span> false,
      <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;MetricValueList&quot;</span>,
      <span class="token string">&quot;verbs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;get&quot;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="7"><li>提交测试使用的 Dataset</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ cat&lt;&lt;EOF <span class="token punctuation">&gt;</span>dataset.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> data.fluid.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Dataset
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> spark
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">mounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPoint</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//mirrors.bit.edu.cn/apache/spark/
      <span class="token key atrule">name</span><span class="token punctuation">:</span> spark
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> data.fluid.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AlluxioRuntime
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> spark
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">tieredstore</span><span class="token punctuation">:</span>
    <span class="token key atrule">levels</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">mediumtype</span><span class="token punctuation">:</span> MEM
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /dev/shm
        <span class="token key atrule">quota</span><span class="token punctuation">:</span> 1Gi
        <span class="token key atrule">high</span><span class="token punctuation">:</span> <span class="token string">&quot;0.99&quot;</span>
        <span class="token key atrule">low</span><span class="token punctuation">:</span> <span class="token string">&quot;0.7&quot;</span>
  <span class="token key atrule">properties</span><span class="token punctuation">:</span>
    <span class="token key atrule">alluxio.user.streaming.data.timeout</span><span class="token punctuation">:</span> 300sec
EOF
$ kubectl create <span class="token punctuation">-</span>f dataset.yaml
dataset.data.fluid.io/spark created
alluxioruntime.data.fluid.io/spark created
</code></pre></div><ol start="8"><li>查看这个 Dataset 是否处于可用状态, 可以看到该数据集的数据总量为 2.71GiB，目前 Fluid 提供的缓存节点数为 1，可以提供的最大缓存能力为 1GiB。此时数据量是无法满足全量数据缓存的需求。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get dataset
NAME    UFS TOTAL SIZE   CACHED   CACHE CAPACITY   CACHED PERCENTAGE   PHASE   AGE
spark   <span class="token number">2</span>.71GiB          <span class="token number">0</span>.00B    <span class="token number">1</span>.00GiB          <span class="token number">0.0</span>%                Bound   7m38s
</code></pre></div><ol start="9"><li>当该 Dataset 处于可用状态后，查看是否已经可以从 custom-metrics-api 获得监控指标</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get <span class="token parameter variable">--raw</span> <span class="token string">&quot;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/datasets.data.fluid.io/*/capacity_used_rate&quot;</span> <span class="token operator">|</span> jq
<span class="token punctuation">{</span>
  <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;MetricValueList&quot;</span>,
  <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;custom.metrics.k8s.io/v1beta1&quot;</span>,
  <span class="token string">&quot;metadata&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;selfLink&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/datasets.data.fluid.io/%2A/capacity_used_rate&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;items&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;describedObject&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Dataset&quot;</span>,
        <span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;default&quot;</span>,
        <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;spark&quot;</span>,
        <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;data.fluid.io/v1alpha1&quot;</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;metricName&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;capacity_used_rate&quot;</span>,
      <span class="token string">&quot;timestamp&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-04-04T07:24:52Z&quot;</span>,
      <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="10"><li>创建 HPA 任务</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ cat&lt;&lt;EOF <span class="token punctuation">&gt;</span> hpa.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> spark
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> data.fluid.io/v1alpha1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> AlluxioRuntime
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spark
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Object
    <span class="token key atrule">object</span><span class="token punctuation">:</span>
      <span class="token key atrule">metric</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> capacity_used_rate
      <span class="token key atrule">describedObject</span><span class="token punctuation">:</span>
        <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> data.fluid.io/v1alpha1
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> Dataset
        <span class="token key atrule">name</span><span class="token punctuation">:</span> spark
      <span class="token key atrule">target</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> Value
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;90&quot;</span>
  <span class="token key atrule">behavior</span><span class="token punctuation">:</span>
    <span class="token key atrule">scaleUp</span><span class="token punctuation">:</span>
      <span class="token key atrule">policies</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Pods
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">2</span>
        <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">scaleDown</span><span class="token punctuation">:</span>
      <span class="token key atrule">selectPolicy</span><span class="token punctuation">:</span> Disabled
EOF
</code></pre></div><p>首先，我们解读一下从样例配置，这里主要有两部分一个是扩缩容的规则，另一个是扩缩容的灵敏度：</p> <ul><li>规则：触发扩容行为的条件为 Dataset 对象的缓存数据量占总缓存能力的 90%; 扩容对象为 AlluxioRuntime, 最小副本数为 1，最大副本数为 4; 而 Dataset 和 AlluxioRuntime 的对象需要在同一个 namespace。</li> <li>策略： 可以 K8s 1.18 以上的版本，可以分别针对扩容和缩容场景设置稳定时间和一次扩缩容步长比例。比如在本例子, 一次扩容周期为 10 分钟(periodSeconds),扩容时新增 2 个副本数，当然这也不可以超过 maxReplicas 的限制；而完成一次扩容后, 冷却时间(stabilizationWindowSeconds)为 20 分钟; 而缩容策略可以选择直接关闭。</li></ul> <ol start="11"><li>查看 HPA 配置，当前缓存空间的数据占比为 0。远远低于触发扩容的条件</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get hpa
NAME    REFERENCE              TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
spark   AlluxioRuntime/spark   <span class="token number">0</span>/90      <span class="token number">1</span>         <span class="token number">4</span>         <span class="token number">1</span>          33s
$ kubectl describe hpa
Name:                                                    spark
Namespace:                                               default
Labels:                                                  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:                                             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
CreationTimestamp:                                       Wed, 07 Apr <span class="token number">2021</span> <span class="token number">17</span>:36:39 +0800
Reference:                                               AlluxioRuntime/spark
Metrics:                                                 <span class="token punctuation">(</span> current / target <span class="token punctuation">)</span>
  <span class="token string">&quot;capacity_used_rate&quot;</span> on Dataset/spark <span class="token punctuation">(</span>target value<span class="token punctuation">)</span>:  <span class="token number">0</span> / <span class="token number">90</span>
Min replicas:                                            <span class="token number">1</span>
Max replicas:                                            <span class="token number">4</span>
Behavior:
  Scale Up:
    Stabilization Window: <span class="token number">0</span> seconds
    Select Policy: Max
    Policies:
      - Type: Pods  Value: <span class="token number">2</span>  Period: <span class="token number">600</span> seconds
  Scale Down:
    Select Policy: Disabled
    Policies:
      - Type: Percent  Value: <span class="token number">100</span>  Period: <span class="token number">15</span> seconds
AlluxioRuntime pods:   <span class="token number">1</span> current / <span class="token number">1</span> desired
Conditions:
  Type            Status  Reason               Message
  ----            ------  ------               -------
  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation
  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from Dataset metric capacity_used_rate
  ScalingLimited  False   DesiredWithinRange   the desired count is within the acceptable range
Events:           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><ol start="12"><li>创建数据预热任务</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ cat&lt;&lt;EOF <span class="token punctuation">&gt;</span> dataload.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> data.fluid.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DataLoad
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> spark
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">dataset</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spark
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
EOF
$ kubectl create <span class="token punctuation">-</span>f dataload.yaml
$ kubectl get dataload
NAME    DATASET   PHASE       AGE   DURATION
spark   spark     Executing   15s   Unfinished
</code></pre></div><ol start="13"><li>此时可以发现缓存的数据量接近了 Fluid 可以提供的缓存能力（1GiB）同时触发了弹性伸缩的条件</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$  kubectl  get dataset
NAME    UFS TOTAL SIZE   CACHED       CACHE CAPACITY   CACHED PERCENTAGE   PHASE   AGE
spark   <span class="token number">2</span>.71GiB          <span class="token number">1020</span>.92MiB   <span class="token number">1</span>.00GiB          <span class="token number">36.8</span>%               Bound   5m15s
</code></pre></div><p>从 HPA 的监控，可以看到 Alluxio Runtime 的扩容已经开始, 可以发现扩容的步长为 2</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get hpa
NAME    REFERENCE              TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
spark   AlluxioRuntime/spark   <span class="token number">100</span>/90    <span class="token number">1</span>         <span class="token number">4</span>         <span class="token number">2</span>          4m20s
$ kubectl describe hpa
Name:                                                    spark
Namespace:                                               default
Labels:                                                  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:                                             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
CreationTimestamp:                                       Wed, 07 Apr <span class="token number">2021</span> <span class="token number">17</span>:56:31 +0800
Reference:                                               AlluxioRuntime/spark
Metrics:                                                 <span class="token punctuation">(</span> current / target <span class="token punctuation">)</span>
  <span class="token string">&quot;capacity_used_rate&quot;</span> on Dataset/spark <span class="token punctuation">(</span>target value<span class="token punctuation">)</span>:  <span class="token number">100</span> / <span class="token number">90</span>
Min replicas:                                            <span class="token number">1</span>
Max replicas:                                            <span class="token number">4</span>
Behavior:
  Scale Up:
    Stabilization Window: <span class="token number">0</span> seconds
    Select Policy: Max
    Policies:
      - Type: Pods  Value: <span class="token number">2</span>  Period: <span class="token number">600</span> seconds
  Scale Down:
    Select Policy: Disabled
    Policies:
      - Type: Percent  Value: <span class="token number">100</span>  Period: <span class="token number">15</span> seconds
AlluxioRuntime pods:   <span class="token number">2</span> current / <span class="token number">3</span> desired
Conditions:
  Type            Status  Reason              Message
  ----            ------  ------              -------
  AbleToScale     True    SucceededRescale    the HPA controller was able to update the target scale to <span class="token number">3</span>
  ScalingActive   True    ValidMetricFound    the HPA was able to successfully calculate a replica count from Dataset metric capacity_used_rate
  ScalingLimited  False   DesiredWithinRange  the desired count is within the acceptable range
Events:
  Type     Reason                        Age                    From                       Message
  ----     ------                        ----                   ----                       -------
  Normal   SuccessfulRescale             21s                    horizontal-pod-autoscaler  New size: <span class="token number">2</span><span class="token punctuation">;</span> reason: Dataset metric capacity_used_rate above target
  Normal   SuccessfulRescale             6s                     horizontal-pod-autoscaler  New size: <span class="token number">3</span><span class="token punctuation">;</span> reason: Dataset metric capacity_used_rate above target
</code></pre></div><ol start="14"><li>在等待一段时间之后发现数据集的缓存空间由 1GiB 提升到了 3GiB，数据缓存已经接近完成</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl  get dataset
NAME    UFS TOTAL SIZE   CACHED    CACHE CAPACITY   CACHED PERCENTAGE   PHASE   AGE
spark   <span class="token number">2</span>.71GiB          <span class="token number">2</span>.59GiB   <span class="token number">3</span>.00GiB          <span class="token number">95.6</span>%               Bound   12m
</code></pre></div><ol start="15"><li>观察 HPA 的状态，可以发现此时 Dataset 对应的 runtime 的 replicas 数量为 3， 已经使用的缓存空间比例 capacity_used_rate 为 85%，已经不会触发缓存扩容。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get hpa
NAME    REFERENCE              TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
spark   AlluxioRuntime/spark   <span class="token number">85</span>/90     <span class="token number">1</span>         <span class="token number">4</span>         <span class="token number">3</span>          11m
</code></pre></div><ol start="16"><li>清理环境</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete hpa spark
$ kubectl delete dataset spark
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>Fluid提供了结合 Prometheous，Kubernetes HPA 和 Custom Metrics 能力，根据占用缓存空间的比例触发自动弹性伸缩的能力，实现缓存能力的按需使用。这样能够帮助用户更加灵活的使用通过分布式缓存提升数据访问加速能力，后续我们会提供定时扩缩的能力，为扩缩容提供更强的确定性。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.23af35ae.js" defer></script><script src="/assets/js/2.886cbf07.js" defer></script><script src="/assets/js/3.43a2579f.js" defer></script><script src="/assets/js/43.47cde8a4.js" defer></script>
  </body>
</html>
