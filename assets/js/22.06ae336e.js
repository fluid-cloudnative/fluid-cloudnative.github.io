(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{384:function(t,a,e){"use strict";e.r(a);var s=e(20),n=Object(s.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"fluid-gives-data-elasticity-a-pair-of-invisible-wings-custom-elastic-expansion"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fluid-gives-data-elasticity-a-pair-of-invisible-wings-custom-elastic-expansion"}},[t._v("#")]),t._v(" Fluid gives data elasticity a pair of invisible wings - Custom elastic expansion")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://fluid-imgs.oss-cn-shanghai.aliyuncs.com/public/imgs/fluid-elastic-01.webp",alt:"fluid_blog"}})]),t._v(" "),a("p",[a("strong",[t._v("Introduction:")]),t._v(" elastic scaling is one of the core capabilities of kubernetes, but it has always been carried out around this stateless application load. Fluid provides the elastic scalability of distributed cache, which can flexibly expand and shrink data cache. It provides performance indicators such as cache space and existing cache proportion based on runtime, and provides data cache scalability on demand in combination with its capacity to expand and shrink runtime resources.")]),t._v(" "),a("h2",{attrs:{id:"background"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#background"}},[t._v("#")]),t._v(" Background")]),t._v(" "),a("p",[t._v("As more and more data intensive applications such as big data and AI begin to be deployed and run in kubernetes environment, the differences between the design concept of data intensive application computing framework and the original flexible application layout of cloud lead to data access and computing bottlenecks. The cloud native data orchestration engine fluid provides the ability to accelerate data access for applications through the abstraction of data sets, the use of distributed cache technology and the combination of scheduler.")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://fluid-imgs.oss-cn-shanghai.aliyuncs.com/public/imgs/fluid-elastic-02.png",alt:"fluid_blog"}})]),t._v(" "),a("p",[t._v("Elastic scaling is one of the core capabilities of kubernetes, but it has always been carried out around this stateless application load. Fluid provides the elastic scalability of distributed cache, which can flexibly expand and shrink data cache. It provides performance indicators such as cache space and existing cache proportion based on runtime, and provides data cache scalability on demand in combination with its capacity to expand and shrink runtime resources.")]),t._v(" "),a("p",[t._v("This capability is very important for big data applications in the Internet scenario, because most big data applications are realized through end-to-end pipeline. The pipeline includes the following steps:")]),t._v(" "),a("ol",[a("li",[a("p",[a("strong",[t._v("data extraction")]),t._v(": use spark, MapReduce and other big data technologies to preprocess the original data.")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("model training")]),t._v(": use the feature data generated in the first stage to train the machine learning model and generate the corresponding model.")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("model evaluation")]),t._v(": evaluate and test the model generated in the second stage through the test set or verification set.")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("model reasoning")]),t._v(": the model verified in the third stage is finally pushed online to provide reasoning services for the business.")])])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://fluid-imgs.oss-cn-shanghai.aliyuncs.com/public/imgs/fluid-elastic-03.webp",alt:"fluid_blog"}})]),t._v(" "),a("p",[t._v("It can be seen that the end-to-end pipeline will contain many different types of computing tasks. For each computing task, there will be an appropriate professional system to handle it in practice (tensorflow, pytorch, spark, PRESTO); However, these systems are independent of each other, and usually transfer data from one stage to the next with the help of external file system. However, frequent use of file system for data exchange will bring a lot of I / O overhead and often become the bottleneck of the whole workflow.")]),t._v(" "),a("p",[t._v("Fluid is very suitable for this scenario. The user can create a dataset object, which has the ability to disperse and cache data to the kubernetes computing node as the medium for data exchange. In this way, remote data writing and reading are avoided and the efficiency of data use is improved. However, the problem here is the resource estimation and reservation of temporary data cache. Before data production and consumption, accurate data volume estimation is difficult to meet. Too high estimation will lead to waste of resource reservation, and too low estimation will increase the possibility of data write failure. Or expand and shrink the capacity on demand, which is more user-friendly. We hope to achieve the use effect similar to page cache. This layer is transparent to end users, but its cache acceleration effect is real.")]),t._v(" "),a("p",[t._v("By customizing the HPA mechanism, we introduce cache elasticity and scalability through fluid. When the buffer capacity reaches a certain elastic ratio, the expansion of the existing buffer space will be triggered. For example, set the trigger condition that the proportion of cache space exceeds 75%. At this time, the total cache space is 10g. When the data has occupied 8g cache space, the capacity expansion mechanism will be triggered.")]),t._v(" "),a("p",[t._v("Let's use an example to help you experience fluid's automatic capacity expansion and contraction capability.")]),t._v(" "),a("h2",{attrs:{id:"preconditions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#preconditions"}},[t._v("#")]),t._v(" Preconditions")]),t._v(" "),a("p",[t._v("It is recommended to use kubernetes 1.18 or above, because HPA cannot customize the expansion and contraction strategy before 1.18, which is implemented through hard coding. After 1.18, you can customize the expansion and contraction strategy, for example, you can define the cooling time after a capacity expansion.")]),t._v(" "),a("h2",{attrs:{id:"specific-steps"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#specific-steps"}},[t._v("#")]),t._v(" Specific steps")]),t._v(" "),a("h3",{attrs:{id:"_1-install-jq-tools-to-facilitate-json-parsing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-install-jq-tools-to-facilitate-json-parsing"}},[t._v("#")]),t._v(" 1. Install JQ tools to facilitate JSON parsing.")]),t._v(" "),a("p",[t._v("In this example, the operating system we use is CentOS. You can install JQ through yum.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" jq\n")])])]),a("h3",{attrs:{id:"_2-download-and-install-the-latest-version-of-fluid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-download-and-install-the-latest-version-of-fluid"}},[t._v("#")]),t._v(" 2. Download and install the latest version of fluid.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/fluid-cloudnative/fluid.git\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" fluid/charts\nkubectl create ns fluid-system\nhelm "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" fluid fluid\n")])])]),a("h3",{attrs:{id:"_3-deploy-or-configure-prometheus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-deploy-or-configure-prometheus"}},[t._v("#")]),t._v(" 3. Deploy or configure Prometheus")]),t._v(" "),a("p",[t._v("Here, the metrics exposed by the cache engine of alluxioruntime are collected by Prometheus. If there is no Prometheus in the cluster:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" fluid\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" integration/prometheus/prometheus.yaml\n")])])]),a("p",[t._v("If there is Prometheus in the cluster, you can write the following configuration to the Prometheus configuration file:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrape_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'alluxio runtime'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metrics_path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /metrics/prometheus\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kubernetes_sd_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" endpoints\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("relabel_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("__meta_kubernetes_service_label_monitor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" alluxio_runtime_metrics\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" keep\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("__meta_kubernetes_endpoint_port_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" web\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" keep\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("__meta_kubernetes_namespace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" namespace\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $1\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" replace\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("__meta_kubernetes_service_label_release"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" fluid_runtime\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $1\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" replace\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("__meta_kubernetes_endpoint_address_target_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pod\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $1\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" replace\n")])])]),a("h3",{attrs:{id:"_4-verify-that-prometheus-is-installed-successfully"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-verify-that-prometheus-is-installed-successfully"}},[t._v("#")]),t._v(" 4. Verify that Prometheus is installed successfully")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ kubectl get ep "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" kube-system  prometheus-svc\nNAME             ENDPOINTS        AGE\nprometheus-svc   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.76")]),t._v(".0.2:9090   6m49s\n$ kubectl get svc "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" kube-system prometheus-svc\nNAME             TYPE       CLUSTER-IP      EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("          AGE\nprometheus-svc   NodePort   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.16")]),t._v(".135.24   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9090")]),t._v(":32114/TCP   2m7s\n")])])]),a("p",[t._v("If you want to visualize the monitoring indicators, you can install grafana to verify the monitoring data. Refer to the documentation for specific operations.")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://fluid-imgs.oss-cn-shanghai.aliyuncs.com/public/imgs/fluid-elastic-04.webp",alt:"fluid_blog"}})]),t._v(" "),a("h3",{attrs:{id:"_5-deploy-metrics-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-deploy-metrics-server"}},[t._v("#")]),t._v(" 5. Deploy metrics server")]),t._v(" "),a("p",[t._v("Check whether the cluster includes metrics server. If you execute 'kubectl top node' and have correct output to display memory and CPU, the cluster's metrics server is configured correctly.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("kubectl "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("top")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v("\nNAME                       CPU"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cores"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   CPU%   MEMORY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   MEMORY%\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.204   93m          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("%     1455Mi          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("%\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.205   125m         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("%     1925Mi          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v("%\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.206   96m          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("%     1689Mi          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v("%\n")])])]),a("p",[t._v("Otherwise, manually execute the following command:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("kubectl create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" integration/metrics-server\n")])])]),a("h3",{attrs:{id:"_6-deploy-the-custom-metrics-api-component"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-deploy-the-custom-metrics-api-component"}},[t._v("#")]),t._v(" 6. Deploy the custom metrics API component.")]),t._v(" "),a("p",[t._v("To extend based on custom metrics, you need to have two components:")]),t._v(" "),a("ul",[a("li",[a("p",[a("strong",[t._v("the first component")]),t._v(" is to collect metrics from the application and store them in the Prometheus time series database.")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("the second component")]),t._v(" uses the collected metrics to extend the kubernetes custom metrics API, namely k8s Prometheus adapter.")])])]),t._v(" "),a("p",[t._v("The first component is deployed in step 3. Next, deploy the second component.")]),t._v(" "),a("p",[t._v("If the custom metrics API has been configured, add the configuration related to dataset in the configmap configuration of the adapter:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ConfigMap\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" adapter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("config\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" monitoring\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config.yaml")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v("\n   \trules: ")]),t._v("\n  \t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("seriesQuery")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{__name__=~"Cluster_(CapacityTotal|CapacityUsed)",fluid_runtime!="",instance!="",job="alluxio runtime",namespace!="",pod!=""}\'')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("seriesFilters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("is")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ^Cluster_(CapacityTotal"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v("CapacityUsed)$\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("overrides")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" namespace\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pod")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pods\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("fluid_runtime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" datasets\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matches")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"^(.*)"')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("as")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"capacity_used_rate"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metricsQuery")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ceil(Cluster_CapacityUsed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("<<.LabelMatchers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token important"}},[t._v("*100/(Cluster_CapacityTotal")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("<<.LabelMatchers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("))\n")])])]),a("p",[t._v("Otherwise, manually execute the following command:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("kubectl create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" integration/custom-metrics-api/namespace.yaml\nkubectl create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" integration/custom-metrics-api\n")])])]),a("blockquote",[a("p",[t._v("Note: since the custom metrics API connects the access address of the Prometheus in the cluster, please replace the Prometheus URL with the Prometheus address you really use.\nCheck custom indicators:")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("\n$ kubectl get "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--raw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/apis/custom.metrics.k8s.io/v1beta1"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" jq\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"APIResourceList"')]),t._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v1"')]),t._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"groupVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"custom.metrics.k8s.io/v1beta1"')]),t._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"resources"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pods/capacity_used_rate"')]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"singularName"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"namespaced"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" true,\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MetricValueList"')]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"verbs"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"get"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"datasets.data.fluid.io/capacity_used_rate"')]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"singularName"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"namespaced"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" true,\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MetricValueList"')]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"verbs"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"get"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"namespaces/capacity_used_rate"')]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"singularName"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"namespaced"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" false,\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MetricValueList"')]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"verbs"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"get"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_7-submit-the-dataset-used-for-the-test"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-submit-the-dataset-used-for-the-test"}},[t._v("#")]),t._v(" 7. Submit the dataset used for the test")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ cat"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v("EOF "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("dataset.yamlapiVersion: data.fluid.io/v1alpha1kind: Datasetmetadata:  name: sparkspec:  mounts:    - mountPoint: https://mirrors.bit.edu.cn/apache/spark/      name: spark---apiVersion: data.fluid.io/v1alpha1kind: AlluxioRuntimemetadata:  name: sparkspec:  replicas: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("  tieredstore:    levels:      - mediumtype: MEM        path: /dev/shm        quota: 1Gi        high: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.99"')]),t._v("        low: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.7"')]),t._v("  properties:    alluxio.user.streaming.data.timeout: 300secEOF$ kubectl create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" dataset.yamldataset.data.fluid.io/spark createdalluxioruntime.data.fluid.io/spark created\n")])])]),a("h3",{attrs:{id:"_8-check-whether-the-dataset-is-available"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-check-whether-the-dataset-is-available"}},[t._v("#")]),t._v(" 8. Check whether the dataset is available")]),t._v(" "),a("p",[t._v("It can be seen that the total amount of data in this dataset is 2.71gib. At present, the number of cache nodes provided by fluid is 1, and the maximum cache capacity that can be provided is 1gib. At this time, the amount of cached data cannot meet the demand.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ kubectl get dataset\nNAME    UFS TOTAL SIZE   CACHED   CACHE CAPACITY   CACHED PERCENTAGE   PHASE   AGE\nspark   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".71GiB          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".00B    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".00GiB          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v("%                Bound   7m38s\n")])])]),a("h3",{attrs:{id:"_9-when-the-dataset-is-available-check-whether-the-monitoring-indicators-can-be-obtained-from-the-custom-metrics-api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-when-the-dataset-is-available-check-whether-the-monitoring-indicators-can-be-obtained-from-the-custom-metrics-api"}},[t._v("#")]),t._v(" 9. When the dataset is available, check whether the monitoring indicators can be obtained from the custom metrics API")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("kubectl get "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--raw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/datasets.data.fluid.io/*/capacity_used_rate"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" jq\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MetricValueList"')]),t._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"custom.metrics.k8s.io/v1beta1"')]),t._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"metadata"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"selfLink"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/datasets.data.fluid.io/%2A/capacity_used_rate"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"items"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"describedObject"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Dataset"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"namespace"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"default"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"spark"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"data.fluid.io/v1alpha1"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"metricName"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"capacity_used_rate"')]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"timestamp"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2021-04-04T07:24:52Z"')]),t._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_10-create-hpa-task"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-create-hpa-task"}},[t._v("#")]),t._v(" 10. Create HPA task")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("\n$ cat"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" hpa.yaml")]),t._v('\napiVersion: autoscaling/v2beta2\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: spark\nspec:\n  scaleTargetRef:\n    apiVersion: data.fluid.io/v1alpha1\n    kind: AlluxioRuntime\n    name: spark\n  minReplicas: 1\n  maxReplicas: 4\n  metrics:\n  - type: Object\n    object:\n      metric:\n        name: capacity_used_rate\n      describedObject:\n        apiVersion: data.fluid.io/v1alpha1\n        kind: Dataset\n        name: spark\n      target:\n        type: Value\n        value: "90"\n  behavior:\n    scaleUp:\n      policies:\n      - type: Pods\n        value: 2\n        periodSeconds: 600\n    scaleDown:\n      selectPolicy: Disabled\nEOF')]),t._v("\n")])])]),a("p",[t._v("First, let's explain the sample configuration. There are two main parts: one is the rules of expansion and contraction, and the other is the sensitivity of expansion and contraction:")]),t._v(" "),a("ul",[a("li",[a("p",[a("strong",[t._v("rule")]),t._v(": the condition that triggers the capacity expansion behavior is that the amount of cached data of the dataset object accounts for 90% of the total cache capacity; The capacity expansion object is' alluxioruntime '. The minimum number of replicas is 1 and the maximum number of replicas is 4; The objects of dataset and alluxioruntime need to be in the same namespace.")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("policy")]),t._v(": k8s versions above 1.18 can be used, and the stabilization time and one-time expansion and contraction step ratio can be set for expansion and contraction scenarios respectively. For example, in this example, a capacity expansion cycle is 10 minutes (periodseconds), and two replicas are added during capacity expansion. Of course, this can not exceed the limit of maxreplicas; After a capacity expansion, the cooling time (stabilization window seconds) is 20 minutes; The volume reduction strategy can be closed directly.")])])]),t._v(" "),a("h3",{attrs:{id:"_11-check-the-hpa-configuration-the-data-proportion-of-the-current-cache-space-is-0-it-is-far-lower-than-the-condition-for-triggering-capacity-expansion"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-check-the-hpa-configuration-the-data-proportion-of-the-current-cache-space-is-0-it-is-far-lower-than-the-condition-for-triggering-capacity-expansion"}},[t._v("#")]),t._v(" 11. Check the HPA configuration. The data proportion of the current cache space is 0. It is far lower than the condition for triggering capacity expansion.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("\n$ kubectl get hpa\nNAME    REFERENCE              TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nspark   AlluxioRuntime/spark   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/90      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("          33s\n$ kubectl describe hpa\nName:                                                    spark\nNamespace:                                               default\nLabels:                                                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nAnnotations:                                             "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nCreationTimestamp:                                       Wed, 07 Apr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2021")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":36:39 +0800\nReference:                                               AlluxioRuntime/spark\nMetrics:                                                 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" current / target "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"capacity_used_rate"')]),t._v(" on Dataset/spark "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("target value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" / "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("90")]),t._v("\nMin replicas:                                            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nMax replicas:                                            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("\nBehavior:\n  Scale Up:\n    Stabilization Window: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" seconds\n    Select Policy: Max\n    Policies:\n      - Type: Pods  Value: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("  Period: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("600")]),t._v(" seconds\n  Scale Down:\n    Select Policy: Disabled\n    Policies:\n      - Type: Percent  Value: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("  Period: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(" seconds\nAlluxioRuntime pods:   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" current / "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" desired\nConditions:\n  Type            Status  Reason               Message\n  ----            ------  ------               -------\n  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation\n  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from Dataset metric capacity_used_rate\n  ScalingLimited  False   DesiredWithinRange   the desired count is within the acceptable range\nEvents:           "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("h3",{attrs:{id:"_12-create-data-preheating-task"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-create-data-preheating-task"}},[t._v("#")]),t._v(" 12. Create data preheating task")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ cat"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" dataload.yaml")]),t._v("\napiVersion: data.fluid.io/v1alpha1\nkind: DataLoad\nmetadata:\n  name: spark\nspec:\n  dataset:\n    name: spark\n    namespace: default\nEOF")]),t._v("\n$ kubectl create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" dataload.yaml\n$ kubectl get dataload\nNAME    DATASET   PHASE       AGE   DURATION\nspark   spark     Executing   15s   Unfinished\n")])])]),a("h3",{attrs:{id:"_13-at-this-time-it-can-be-found-that-the-amount-of-cached-data-is-close-to-the-cache-capacity-1gib-that-fluid-can-provide-and-the-elastic-scaling-condition-is-triggered"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-at-this-time-it-can-be-found-that-the-amount-of-cached-data-is-close-to-the-cache-capacity-1gib-that-fluid-can-provide-and-the-elastic-scaling-condition-is-triggered"}},[t._v("#")]),t._v(" 13. At this time, it can be found that the amount of cached data is close to the cache capacity (1gib) that fluid can provide, and the elastic scaling condition is triggered")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$  kubectl  get dataset\nNAME    UFS TOTAL SIZE   CACHED       CACHE CAPACITY   CACHED PERCENTAGE   PHASE   AGE\nspark   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".71GiB          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1020")]),t._v(".92MiB   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".00GiB          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("36.8")]),t._v("%               Bound   5m15s\n")])])]),a("p",[t._v("From the monitoring of HPA, it can be seen that the expansion of alluxio runtime has started. It can be found that the step size of expansion is 2.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("\n$ kubectl get hpa\nNAME    REFERENCE              TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nspark   AlluxioRuntime/spark   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("/90    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("          4m20s\n$ kubectl describe hpa\nName:                                                    spark\nNamespace:                                               default\nLabels:                                                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nAnnotations:                                             "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nCreationTimestamp:                                       Wed, 07 Apr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2021")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":56:31 +0800\nReference:                                               AlluxioRuntime/spark\nMetrics:                                                 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" current / target "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"capacity_used_rate"')]),t._v(" on Dataset/spark "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("target value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v(" / "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("90")]),t._v("\nMin replicas:                                            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nMax replicas:                                            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("\nBehavior:\n  Scale Up:\n    Stabilization Window: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" seconds\n    Select Policy: Max\n    Policies:\n      - Type: Pods  Value: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("  Period: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("600")]),t._v(" seconds\n  Scale Down:\n    Select Policy: Disabled\n    Policies:\n      - Type: Percent  Value: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("  Period: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(" seconds\nAlluxioRuntime pods:   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" current / "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" desired\nConditions:\n  Type            Status  Reason              Message\n  ----            ------  ------              -------\n  AbleToScale     True    SucceededRescale    the HPA controller was able to update the target scale to "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n  ScalingActive   True    ValidMetricFound    the HPA was able to successfully calculate a replica count from Dataset metric capacity_used_rate\n  ScalingLimited  False   DesiredWithinRange  the desired count is within the acceptable range\nEvents:\n  Type     Reason                        Age                    From                       Message\n  ----     ------                        ----                   ----                       -------\n  Normal   SuccessfulRescale             21s                    horizontal-pod-autoscaler  New size: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" reason: Dataset metric capacity_used_rate above target\n  Normal   SuccessfulRescale             6s                     horizontal-pod-autoscaler  New size: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" reason: Dataset metric capacity_used_rate above target\n")])])]),a("h3",{attrs:{id:"_14-after-waiting-for-a-period-of-time-it-is-found-that-the-cache-space-of-the-data-set-has-increased-from-1gib-to-3gib-and-the-data-cache-is-almost-complete"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_14-after-waiting-for-a-period-of-time-it-is-found-that-the-cache-space-of-the-data-set-has-increased-from-1gib-to-3gib-and-the-data-cache-is-almost-complete"}},[t._v("#")]),t._v(" 14. After waiting for a period of time, it is found that the cache space of the data set has increased from 1gib to 3gib, and the data cache is almost complete")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ kubectl  get dataset\nNAME    UFS TOTAL SIZE   CACHED    CACHE CAPACITY   CACHED PERCENTAGE   PHASE   AGE\nspark   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".71GiB          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".59GiB   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(".00GiB          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("95.6")]),t._v("%               Bound   12m\n")])])]),a("p",[t._v("At the same time, by observing the status of HPA, it can be found that the number of replicas in the runtime corresponding to the dataset is 3, and the proportion of cache space used is capacity_ used_ When the rate is 85%, the cache expansion will not be triggered.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ kubectl get hpa\nNAME    REFERENCE              TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nspark   AlluxioRuntime/spark   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("85")]),t._v("/90     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("          11m\n")])])]),a("h3",{attrs:{id:"_15-clean-up-the-environment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_15-clean-up-the-environment"}},[t._v("#")]),t._v(" 15. Clean up the environment")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("skubectl delete hpa spark\nkubectl delete dataset spark\n")])])]),a("h2",{attrs:{id:"summary"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#summary"}},[t._v("#")]),t._v(" Summary")]),t._v(" "),a("p",[t._v("Fluid provides the ability to trigger automatic elastic scaling according to the proportion of cache space occupied by the combination of prometheous, kubernetes HPA and custom metrics, so as to realize the on-demand use of cache capacity. This can help users use more flexibly and improve data access acceleration through distributed caching. In the future, we will provide the ability of regular expansion and contraction to provide greater certainty for expansion and contraction.\nFluid's code warehouse: https://github.com/fluid-cloudnative/fluid.git , welcome to pay attention, contribute code and star.")])])}),[],!1,null,null,null);a.default=n.exports}}]);