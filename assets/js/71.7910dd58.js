(window.webpackJsonp=window.webpackJsonp||[]).push([[71],{430:function(t,a,s){"use strict";s.r(a);var e=s(19),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"table-of-contents"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#table-of-contents"}},[t._v("#")]),t._v(" Table of Contents")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E9%83%A8%E7%BD%B2-prometheus-%E5%92%8C-grafana-%E7%9B%91%E6%8E%A7-fluid-%E5%BA%94%E7%94%A8"}},[t._v("部署 prometheus 和 grafana 监控 Fluid 应用")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#1-%E9%83%A8%E7%BD%B2%E6%88%96%E9%85%8D%E7%BD%AE-prometheus"}},[t._v("1. 部署或配置 Prometheus")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#2-%E9%83%A8%E7%BD%B2-grafana"}},[t._v("2. 部署 grafana")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#3-%E9%85%8D%E7%BD%AE-grafana"}},[t._v("3. 配置 grafana")])])])])]),t._v(" "),a("p",[t._v("Created by "),a("a",{attrs:{href:"https://github.com/ekalinin/github-markdown-toc",target:"_blank",rel:"noopener noreferrer"}},[t._v("gh-md-toc"),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"部署-prometheus-和-grafana-监控-fluid-应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署-prometheus-和-grafana-监控-fluid-应用"}},[t._v("#")]),t._v(" 部署 prometheus 和 grafana 监控 Fluid 应用")]),t._v(" "),a("p",[t._v("注：prometheus 需要In-Cluster部署")]),t._v(" "),a("h4",{attrs:{id:"_1-部署或配置-prometheus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-部署或配置-prometheus"}},[t._v("#")]),t._v(" 1. 部署或配置 Prometheus")]),t._v(" "),a("p",[t._v("如果集群内无 prometheus:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" fluid\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" integration/prometheus/prometheus.yaml\n")])])]),a("p",[t._v("如集群内有 prometheus,可将以下配置写到 prometheus 配置文件中:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrape_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'alluxio runtime'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metrics_path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /metrics/prometheus\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kubernetes_sd_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" endpoints\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("relabel_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("__meta_kubernetes_service_label_monitor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" alluxio_runtime_metrics\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" keep\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("__meta_kubernetes_endpoint_port_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" web\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" keep\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("__meta_kubernetes_namespace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" namespace\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $1\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" replace\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("__meta_kubernetes_service_label_release"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" fluid_runtime\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $1\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" replace\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("__meta_kubernetes_endpoint_address_target_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pod\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $1\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" replace\n")])])]),a("h4",{attrs:{id:"_2-部署-grafana"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-部署-grafana"}},[t._v("#")]),t._v(" 2. 部署 grafana")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker 部署")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),t._v(":3000 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("grafana "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--restart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("always "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" grafana "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  grafana/grafana\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# In-CLuster 部署")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" fluid\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" integration/prometheus/grafana.yaml \n")])])]),a("h4",{attrs:{id:"_3-配置-grafana"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置-grafana"}},[t._v("#")]),t._v(" 3. 配置 grafana")]),t._v(" "),a("ol",[a("li",[t._v("登录 grafana\n如果以docker 方式部署，访问 "),a("code",[t._v("http://$grafana-node-ip:3000")]),t._v(";以 In-CLuster 方式部署，访问"),a("code",[t._v("http://$grafana-node-ip:NodePort")]),t._v("，默认账号密码 "),a("code",[t._v("admin:admin")]),t._v(":")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# 查看 NodePort\n$ kubectl describe svc monitoring-grafana -n kube-system\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("首先查看 prometheus svc 端口")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('$ kubectl get svc -n kube-system | grep prometheus-svc\nprometheus-svc             NodePort    10.100.0.144   <none>        9090:31245/TCP           22h\n$ kubectl describe svc prometheus-svc -n kube-system\nName:                     prometheus-svc\nNamespace:                kube-system\nLabels:                   kubernetes.io/name=Prometheus\n                          name=prometheus-svc\nAnnotations:              kubectl.kubernetes.io/last-applied-configuration:\n                            {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"labels":{"kubernetes.io/name":"Prometheus","name":"prometheus-svc"},"nam...\nSelector:                 app=prometheus\nType:                     NodePort\nIP:                       10.100.0.144\nPort:                     prometheus  9090/TCP\nTargetPort:               9090/TCP\nNodePort:                 prometheus  31245/TCP\nEndpoints:                10.99.224.138:9090\nSession Affinity:         None\nExternal Traffic Policy:  Cluster\nEvents:                   <none>\n')])])]),a("ol",{attrs:{start:"3"}},[a("li",[t._v("配置 prometheus data source")])]),t._v(" "),a("p",[t._v("注: 如果 grafana In-Cluster 部署， URL 填写 Service Endpoints 即可；如果以 docker 方式部署，URL 填写prometheus 部署节点 ip:NodePort 即可\n导入完成后点击Save & Test 显示 Data source is working 即可")]),t._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[a("p",[t._v("导入模板文件\ngrafana 选择导入模板 Json 文件 "),a("code",[t._v("fluid-prometheus-grafana-monitor.json")]),t._v(", 它的位置是"),a("code",[t._v("integration/prometheus/fluid-prometheus-grafana-monitor.json")])])]),t._v(" "),a("li",[a("p",[t._v("启动 fluid 任务")])])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[t._v("$ cat<<EOF "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("dataset.yaml\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" data.fluid.io/v1alpha1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Dataset\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" spark\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mountPoint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//mirrors.bit.edu.cn/apache/spark/\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" spark\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" data.fluid.io/v1alpha1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" AlluxioRuntime\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" spark\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tieredstore")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("levels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mediumtype")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" MEM\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /dev/shm\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("quota")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1Gi\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("high")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.95"')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("low")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.7"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 默认在v0.5.0版本之后，alluxio runtime已经开启了Prometheous数据，如果需要关闭可以主动设置disablePrometheus: true")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# disablePrometheus: false  ")]),t._v("\nEOF\n")])])]),a("blockquote",[a("p",[t._v("注意：默认Prometheous是开启的。如果需要关闭Prometheous，可以设置 disablePrometheus: true, 默认为 false")])]),t._v(" "),a("ol",{attrs:{start:"6"}},[a("li",[t._v("查看监控\n在 grafana HOME 中知道名为Fluid-Prometheus-Grafana-Monitor视图即可，如下所示:")])]),t._v(" "),a("p",[t._v("注：User of runtime 对应Fluid Alluxio runtime user; fluid_runtime 对应Fluid runtime name; namespace 对应Fluid runtime namespace")])])}),[],!1,null,null,null);a.default=n.exports}}]);